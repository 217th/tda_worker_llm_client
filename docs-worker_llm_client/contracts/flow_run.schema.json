{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.local/schemas/flow_run.schema.json",
  "title": "FlowRun",
  "type": "object",
  "additionalProperties": false,
  "required": ["schemaVersion", "runId", "flowKey", "status", "createdAt", "trigger", "scope", "steps"],
  "properties": {
    "schemaVersion": {
      "type": "integer",
      "minimum": 1,
      "description": "Версия схемы документа flow_run."
    },
    "runId": {
      "type": "string",
      "description": "docId в Firestore. Формат: YYYYMMDD-HHmmss_<symbolSlug>_<shortSuffix>.",
      "pattern": "^[0-9]{8}-[0-9]{6}_[A-Z0-9]+(?:-[A-Z0-9]+)*_[a-z0-9]{3,6}$"
    },
    "flowKey": {
      "type": "string",
      "description": "Человекочитаемый ключ флоу с версией суффиксом, например scheduled_month_week_report_v1.",
      "pattern": "^[a-z][a-z0-9_]*_v[0-9]+$"
    },
    "status": {
      "type": "string",
      "enum": ["PENDING", "RUNNING", "SUCCEEDED", "FAILED", "CANCELLED"]
    },
    "createdAt": {
      "$ref": "#/$defs/rfc3339Timestamp"
    },
    "updatedAt": {
      "$ref": "#/$defs/rfc3339Timestamp"
    },
    "finishedAt": {
      "$ref": "#/$defs/rfc3339Timestamp"
    },
    "trigger": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "source"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["SCHEDULER", "USER", "SYSTEM", "DEBUG_HTTP"]
        },
        "source": {
          "type": "string",
          "minLength": 1,
          "description": "Например Cloud Scheduler job name или HTTP endpoint."
        }
      }
    },
    "scope": {
      "type": "object",
      "description": "Параметры запуска. Разрешены дополнительные поля (по мере роста прототипа).",
      "required": ["symbol"],
      "properties": {
        "symbol": {
          "type": "string",
          "minLength": 1,
          "description": "Базовый торговый символ без слэша (например BTCUSDT)."
        }
      },
      "additionalProperties": true
    },
    "progress": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "currentStepId": {
          "type": "string",
          "minLength": 1
        },
        "stepCounts": {
          "type": "object",
          "additionalProperties": false,
          "required": ["total"],
          "properties": {
            "total": { "type": "integer", "minimum": 0 },
            "pending": { "type": "integer", "minimum": 0 },
            "ready": { "type": "integer", "minimum": 0 },
            "running": { "type": "integer", "minimum": 0 },
            "succeeded": { "type": "integer", "minimum": 0 },
            "failed": { "type": "integer", "minimum": 0 },
            "skipped": { "type": "integer", "minimum": 0 },
            "cancelled": { "type": "integer", "minimum": 0 }
          }
        }
      }
    },
    "steps": {
      "type": "object",
      "description": "Map шагов по stepId. Ключи — детерминированные stepId.",
      "additionalProperties": { "$ref": "#/$defs/flowStep" }
    },
    "error": {
      "$ref": "#/$defs/error"
    }
  },
  "$defs": {
    "rfc3339Timestamp": {
      "type": "string",
      "format": "date-time"
    },
    "error": {
      "type": "object",
      "additionalProperties": false,
      "required": ["code", "message"],
      "properties": {
        "code": { "type": "string", "minLength": 1 },
        "message": { "type": "string", "minLength": 1 },
        "details": {
          "type": "object",
          "description": "Произвольные детали ошибки (без строгой схемы на старте).",
          "additionalProperties": true
        }
      }
    },
    "flowStep": {
      "oneOf": [
        { "$ref": "#/$defs/ohlcvExportStep" },
        { "$ref": "#/$defs/chartExportStep" },
        { "$ref": "#/$defs/llmReportStep" },
        { "$ref": "#/$defs/genericStep" }
      ]
    },
    "baseStep": {
      "type": "object",
      "additionalProperties": false,
      "required": ["stepType", "status", "createdAt", "dependsOn", "inputs", "outputs"],
      "properties": {
        "stepType": { "type": "string" },
        "status": {
          "type": "string",
          "enum": ["PENDING", "READY", "RUNNING", "SUCCEEDED", "FAILED", "SKIPPED", "CANCELLED"]
        },
        "timeframe": {
          "type": "string",
          "description": "Например 1M/1w/1d/4h/1h."
        },
        "createdAt": { "$ref": "#/$defs/rfc3339Timestamp" },
        "finishedAt": { "$ref": "#/$defs/rfc3339Timestamp" },
        "dependsOn": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "inputs": {
          "type": "object",
          "description": "Входы шага. Содержимое зависит от stepType.",
          "additionalProperties": true
        },
        "outputs": {
          "type": "object",
          "description": "Выходы шага. Содержимое зависит от stepType.",
          "additionalProperties": true
        },
        "error": { "$ref": "#/$defs/error" }
      }
    },
    "ohlcvExportStep": {
      "allOf": [
        { "$ref": "#/$defs/baseStep" },
        {
          "type": "object",
          "required": ["timeframe"],
          "properties": {
            "stepType": { "const": "OHLCV_EXPORT" },
            "inputs": {
              "type": "object",
              "additionalProperties": true,
              "required": ["symbol", "timeframe", "source", "exportMode"],
              "properties": {
                "source": { "const": "bigquery" },
                "symbol": { "type": "string", "minLength": 1 },
                "timeframe": { "type": "string", "minLength": 1 },
                "exchange": {
                  "type": "string",
                  "description": "Опционально: фильтр по бирже, если в BigQuery есть данные с нескольких бирж.",
                  "minLength": 1
                },
                "dataset": { "type": "string" },
                "table": { "type": "string" },
                "exportMode": {
                  "type": "string",
                  "description": "Что экспортировать: весь ряд или диапазон дат.",
                  "enum": ["all", "range"]
                },
                "rangeFrom": {
                  "$ref": "#/$defs/rfc3339Timestamp",
                  "description": "Начало диапазона (включительно), если exportMode=range."
                },
                "rangeTo": {
                  "$ref": "#/$defs/rfc3339Timestamp",
                  "description": "Конец диапазона (включительно), если exportMode=range."
                }
              }
            },
            "outputs": {
              "type": "object",
              "additionalProperties": true,
              "properties": {
                "gcs_uri": { "type": "string", "pattern": "^gs://.+" },
                "expires_at": { "$ref": "#/$defs/rfc3339Timestamp" }
              }
            }
          }
        },
        {
          "if": { "properties": { "inputs": { "properties": { "exportMode": { "const": "range" } } } } },
          "then": { "properties": { "inputs": { "required": ["rangeFrom", "rangeTo"] } } }
        },
        {
          "if": { "properties": { "status": { "const": "SUCCEEDED" } } },
          "then": { "properties": { "outputs": { "required": ["gcs_uri"] } } }
        }
      ]
    },
    "chartExportStep": {
      "allOf": [
        { "$ref": "#/$defs/baseStep" },
        {
          "type": "object",
          "required": ["timeframe"],
          "properties": {
            "stepType": { "const": "CHART_EXPORT" },
            "inputs": {
              "type": "object",
              "additionalProperties": true,
              "required": ["minImages", "requests"],
              "properties": {
                "requests": {
                  "type": "array",
                  "description": "Список запрошенных изображений. Семантика (kind и т.п.) живёт внутри шаблонов и отражается в outputs.",
                  "minItems": 1,
                  "items": {
                    "type": "object",
                    "additionalProperties": false,
                    "required": ["chartTemplateId"],
                    "properties": {
                      "chartTemplateId": { "type": "string", "minLength": 1 }
                    }
                  }
                },
                "minImages": {
                  "type": "integer",
                  "minimum": 0,
                  "description": "Минимальное число успешно сгенерированных изображений для статуса SUCCEEDED."
                },
                "ohlcv_gcs_uri": {
                  "type": "string",
                  "description": "Опционально: ссылка на OHLCV JSON, если нужно для контекста/логирования/валидации.",
                  "pattern": "^gs://.+"
                }
              }
            },
            "outputs": {
              "type": "object",
              "additionalProperties": true,
              "properties": {
                "gcs_uri": {
                  "type": "string",
                  "description": "Primary output artifact for this step (charts manifest JSON).",
                  "pattern": "^gs://.+"
                },
                "expires_at": { "$ref": "#/$defs/rfc3339Timestamp" }
              }
            }
          }
        },
        {
          "if": { "properties": { "status": { "const": "SUCCEEDED" } } },
          "then": { "properties": { "outputs": { "required": ["gcs_uri"] } } }
        }
      ]
    },
    "llmReportStep": {
      "allOf": [
        { "$ref": "#/$defs/baseStep" },
        {
          "type": "object",
          "required": ["timeframe"],
          "properties": {
            "stepType": { "const": "LLM_REPORT" },
            "inputs": {
              "type": "object",
              "additionalProperties": true,
              "required": ["llm", "ohlcvStepId", "chartsManifestStepId"],
              "properties": {
                "llm": {
                  "type": "object",
                  "additionalProperties": true,
                  "required": ["promptId", "llmProfile"],
                  "properties": {
                    "promptId": { "type": "string", "minLength": 1 },
                    "llmProfile": {
                      "type": "object",
                      "additionalProperties": false,
                      "anyOf": [{ "required": ["modelName"] }, { "required": ["model"] }],
                      "properties": {
                        "modelName": {
                          "type": "string",
                          "minLength": 1,
                          "description": "Gemini model name (e.g. gemini-2.0-flash)."
                        },
                        "model": {
                          "type": "string",
                          "minLength": 1,
                          "description": "Deprecated alias for modelName."
                        },
                        "temperature": { "type": "number" },
                        "topP": { "type": "number" },
                        "topK": { "type": "integer", "minimum": 0 },
                        "maxOutputTokens": { "type": "integer", "minimum": 1 },
                        "stopSequences": {
                          "type": "array",
                          "items": { "type": "string" }
                        },
                        "candidateCount": { "type": "integer", "minimum": 1, "maximum": 1 },
                        "responseMimeType": {
                          "type": "string",
                          "description": "Prefer application/json when using structured output."
                        },
                        "structuredOutput": {
                          "type": "object",
                          "additionalProperties": false,
                          "description": "Structured output configuration. Schema is referenced via the schema registry (llm_schemas/{schemaId}).",
                          "required": ["schemaId"],
                          "properties": {
                            "schemaId": { "type": "string", "pattern": "^[a-z0-9_]{1,128}$" },
                            "schemaSha256": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
                            "kind": { "type": "string", "enum": ["LLM_REPORT_OUTPUT"] }
                          }
                        },
                        "responseSchema": {
                          "type": "object",
                          "description": "Optional JSON Schema for structured output."
                        },
                        "jsonSchema": {
                          "type": "object",
                          "description": "Alias for responseSchema."
                        },
                        "thinkingConfig": {
                          "type": "object",
                          "additionalProperties": false,
                          "properties": {
                            "includeThoughts": { "type": "boolean" },
                            "thinkingLevel": {
                              "description": "Provider-specific; keep as string or integer based on chosen SDK.",
                              "anyOf": [{ "type": "string" }, { "type": "integer" }]
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "ohlcvStepId": {
                  "type": "string",
                  "description": "StepId of an OHLCV_EXPORT step whose output artifact should be used as input context for this LLM_REPORT step.",
                  "minLength": 1
                },
                "chartsManifestStepId": {
                  "type": "string",
                  "description": "StepId of a CHART_EXPORT step; worker resolves its primary output (charts manifest JSON) via steps[chartsManifestStepId].outputs.gcs_uri.",
                  "minLength": 1
                },
                "previousReportStepIds": {
                  "type": "array",
                  "description": "Optional: stepIds of previous LLM_REPORT steps whose report artifacts may be included as context.",
                  "items": { "type": "string", "minLength": 1 }
                }
              }
            },
            "outputs": {
              "type": "object",
              "additionalProperties": true,
              "properties": {
                "gcs_uri": { "type": "string", "pattern": "^gs://.+" },
                "execution": {
                  "type": "object",
                  "additionalProperties": true,
                  "properties": {
                    "timing": {
                      "type": "object",
                      "additionalProperties": false,
                      "required": ["startedAt", "finishedAt", "durationMs"],
                      "properties": {
                        "startedAt": { "$ref": "#/$defs/rfc3339Timestamp" },
                        "finishedAt": { "$ref": "#/$defs/rfc3339Timestamp" },
                        "durationMs": { "type": "integer", "minimum": 0 }
                      }
                    },
                    "llm": {
                      "type": "object",
                      "additionalProperties": true,
                      "required": ["finishReason"],
                      "properties": {
                        "finishReason": { "type": "string", "minLength": 1 },
                        "modelVersion": { "type": "string" },
                        "usageMetadata": {
                          "type": "object",
                          "additionalProperties": true,
                          "properties": {
                            "promptTokenCount": { "type": "integer", "minimum": 0 },
                            "totalTokenCount": { "type": "integer", "minimum": 0 },
                            "thoughtsTokenCount": { "type": "integer", "minimum": 0 }
                          }
                        },
                        "requestId": { "type": "string" },
                        "operationId": { "type": "string" }
                      }
                    },
                    "reused": {
                      "type": "boolean",
                      "description": "Optional: true if the worker detected an existing deterministic artifact and finalized without re-calling the LLM."
                    }
                  }
                }
              }
            }
          }
        },
        {
          "if": { "properties": { "status": { "const": "SUCCEEDED" } } },
          "then": { "properties": { "outputs": { "required": ["gcs_uri"] } } }
        }
      ]
    },
    "genericStep": {
      "allOf": [
        { "$ref": "#/$defs/baseStep" },
        {
          "type": "object",
          "properties": {
            "stepType": {
              "type": "string",
              "enum": ["LLM_RECOMMENDATION", "ACCOUNT_EXPORT", "INDICATORS_ON_DEMAND", "NEWS_EXPORT"]
            },
            "inputs": {
              "type": "object",
              "additionalProperties": true
            },
            "outputs": {
              "type": "object",
              "additionalProperties": true
            }
          }
        }
      ]
    }
  }
}


